<!doctype html><html><head><meta charset=utf-8><meta name=generator content="Hugo 0.118.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=keywords content="ZgotmplZ"><meta name=description content><meta name=author content="Debdut Chakraborty"><meta name=copyright content="Debdut Chakraborty"><meta http-equiv=content-language content="zh,en"><link rel=canonical href=https://debdutdeb.github.io/blog/2022/06/creating-shell-builtins/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Creating Shell Builtins&nbsp;&ndash;&nbsp;Blog</title><link rel=preconnect href=https://cdn.jsdelivr.net/ crossorigin><link rel=dns-prefetch href=https://cdn.jsdelivr.net/><link rel=dns-prefetch href=https://fonts.gstatic.com/><link rel=preload href=/blog/css/core.min.7fea1f5a41ad0e665eeb874055b0e68e8a11091c60801d2e241269731df6f3b4cd1871c64da457ede9e3d44dcee5732b.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/blog/css/core.min.7fea1f5a41ad0e665eeb874055b0e68e8a11091c60801d2e241269731df6f3b4cd1871c64da457ede9e3d44dcee5732b.css integrity=sha384-f+ofWkGtDmZe64dAVbDmjooRCRxggB0uJBJpcx3287TNGHHGTaRX7enj1E3O5XMr></noscript><style type=text/css>*,::before,::after{margin:0;padding:0;box-sizing:border-box}html{font-family:-system-ui,-apple-system,BlinkMacSystemFont,helvetica neue,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol;font-size:17px;font-weight:400;line-height:2;scroll-behavior:smooth;transition:color .3s,background-color .3s;word-wrap:break-word;-webkit-text-size-adjust:100%}html[data-theme=dark] img{opacity:.7;transition:opacity .5s ease-in-out}html{background:#fff;--site-name-color:#3f4b67;--color-primary:#005ab4;--link-underline:#90cff9;--blockquote-border-left:6px solid #0051a2;--block-background-color:#f7faff;--pag-background-color:rgba(0, 122, 255, .5);--box-shadow:1px 1px 2px rgba(0,0,0,.125);--title-color:#303033;--body-color:#444}html[data-theme=dark]{background:#22272e;--site-name-color:#539bf5;--color-primary:#99bde1;--link-underline:#0051a2;--blockquote-border-left:6px solid #5176bf;--block-background-color:#002c58;--box-shadow:none;--title-color:#dadada;--body-color:#e9e9e9}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1;margin-block-start:0;margin-block-end:0}h1{font-size:26px}h2{font-size:24px}h3{font-size:22px}section>h1{color:var(--title-color)}a{color:var(--color-primary);text-decoration-thickness:.2rem;text-decoration-color:var(--link-underline)}a:hover{text-decoration-color:var(--color-primary)}.wrapper{display:grid;grid-template-columns:1fr min(65ch,calc(100% - 64px))1fr;grid-column-gap:32px}.wrapper>section{grid-column:2}.header{margin:20px 0;display:-webkit-flex;display:flex;flex-wrap:wrap;text-align:initial;padding:15px 0;border-bottom:1px solid #f0f0f0;justify-content:space-between;align-items:baseline}.site-name{display:inline-block;font-weight:600;font-size:21px;color:var(--site-name-color)}.site-logo{height:38px;border-radius:3px;vertical-align:middle;margin-right:8px}.nav-item{display:inline-block;font-size:18px;padding:4px 6px;margin:2px 3px 2px 0;line-height:2;white-space:nowrap}.data-theme-btn{border:none;vertical-align:middle;transition:.3s;background-color:Transparent;background-repeat:no-repeat;cursor:pointer;overflow:hidden;outline:none;padding-right:0;padding-left:0}html[data-theme=light] .light-hidden{display:none}html[data-theme=dark] .dark-hidden{display:none}.note-list{margin:0;padding:0;list-style:none}.note-list .item{position:relative;width:100%;margin-top:25px}.note-list .item:last-child{border:0!important}.note-title{font-size:19px;font-weight:700}.note-date,.note-content{font-size:15px;text-decoration:none;color:var(--body-color)}.note-content,.note-imgs,.note-labels{margin-top:4px;text-align:justify;text-justify:inter-word}.article-tag,.article-category{display:inline-block;font-size:15px;line-height:1;padding:4px 6px;margin:2px 3px 2px 0;white-space:nowrap;border-radius:3px}.article-category{color:#3a8c42}.article-category .hashtag,.article-tag .hashtag{font-weight:700;opacity:.5}.footer{font-size:13px;margin:40px 0 20px}.footer-wrap{text-align:center;color:var(--body-color)}.tag-cloud{margin:2em 0 3em;text-align:center}.tag-cloud-tags{display:inline-block;position:relative;margin:5px;word-wrap:break-word;overflow-wrap:break-word}.archive-year{font-size:20px;font-weight:800;color:var(--title-color);margin-top:20px;margin-bottom:10px}.archive-list{list-style:none}.archive-date{flex:0 0 100px;color:var(--title-color)}.archive-text{color:var(--body-color)}ul.archive-list li{display:flex}.article-containter{margin-bottom:20px}.article-header{margin:20px 0}.article-date{font-size:14px;margin-top:20px;color:#838387}.lastmod-date{font-size:14px;color:#838387}.markdown-body{color:var(--body-color)}.markdown-body p{margin-top:0;margin-bottom:20px}.pagination{display:block;text-align:center;margin:20px 0 40px}.pagination ul{display:inline-block;list-style:none;font-weight:600;padding:0;margin:0}.pagination ul li{display:inline}.pagination ul li a{color:var(--color-primary);float:left;padding:8px 16px;text-decoration:none}.pagination ul li a:hover:not(.active){background-color:var(--pag-background-color)}.pagination ul li a.active{background-color:var(--color-primary);color:var(--block-background-color)}@font-face{font-family:averia sans libre;font-style:italic;font-weight:300;font-display:swap;src:local('Averia Sans Libre Light Italic'),local('AveriaSansLibre-LightItalic'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6caxZG_G5OvCf_rt7FH3B6BHLMEdVLKisSH5DdLw.ttf)format('truetype')}@font-face{font-family:averia sans libre;font-style:italic;font-weight:400;font-display:swap;src:local('Averia Sans Libre Italic'),local('AveriaSansLibre-Italic'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6RaxZG_G5OvCf_rt7FH3B6BHLMEdVLIoAwDw.ttf)format('truetype')}@font-face{font-family:averia sans libre;font-style:italic;font-weight:700;font-display:swap;src:local('Averia Sans Libre Bold Italic'),local('AveriaSansLibre-BoldItalic'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6caxZG_G5OvCf_rt7FH3B6BHLMEdVLKjsVH5DdLw.ttf)format('truetype')}@font-face{font-family:averia sans libre;font-style:normal;font-weight:300;font-display:swap;src:local('Averia Sans Libre Light'),local('AveriaSansLibre-Light'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6SaxZG_G5OvCf_rt7FH3B6BHLMEd3lMJcXL5c.ttf)format('truetype')}@font-face{font-family:averia sans libre;font-style:normal;font-weight:400;font-display:swap;src:local('Averia Sans Libre Regular'),local('AveriaSansLibre-Regular'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6XaxZG_G5OvCf_rt7FH3B6BHLMEdVOEoc.ttf)format('truetype')}@font-face{font-family:averia sans libre;font-style:normal;font-weight:700;font-display:swap;src:local('Averia Sans Libre Bold'),local('AveriaSansLibre-Bold'),url(https://fonts.gstatic.com/s/averiasanslibre/v8/ga6SaxZG_G5OvCf_rt7FH3B6BHLMEd31N5cXL5c.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:italic;font-weight:400;font-display:swap;src:local('Source Code Pro Italic'),local('SourceCodePro-It'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_QiYsKILxRpg3hIP6sJ7fM7PqlONvUlMc.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:italic;font-weight:500;font-display:swap;src:local('Source Code Pro Medium Italic'),local('SourceCodePro-MediumIt'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_ViYsKILxRpg3hIP6sJ7fM7PqlONMnt9co5mg.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:italic;font-weight:600;font-display:swap;src:local('Source Code Pro SemiBold Italic'),local('SourceCodePro-SemiBoldIt'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_ViYsKILxRpg3hIP6sJ7fM7PqlONMLsNco5mg.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:italic;font-weight:700;font-display:swap;src:local('Source Code Pro Bold Italic'),local('SourceCodePro-BoldIt'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_ViYsKILxRpg3hIP6sJ7fM7PqlONNvsdco5mg.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:local('Source Code Pro Regular'),local('SourceCodePro-Regular'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPevT.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:normal;font-weight:500;font-display:swap;src:local('Source Code Pro Medium'),local('SourceCodePro-Medium'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_XiYsKILxRpg3hIP6sJ7fM7PqtzsjDs-cv.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:normal;font-weight:600;font-display:swap;src:local('Source Code Pro SemiBold'),local('SourceCodePro-SemiBold'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_XiYsKILxRpg3hIP6sJ7fM7Pqt4s_Ds-cv.ttf)format('truetype')}@font-face{font-family:source code pro;font-style:normal;font-weight:700;font-display:swap;src:local('Source Code Pro Bold'),local('SourceCodePro-Bold'),url(https://fonts.gstatic.com/s/sourcecodepro/v11/HI_XiYsKILxRpg3hIP6sJ7fM7Pqths7Ds-cv.ttf)format('truetype')}html{font-family:averia sans libre,-system-ui,-apple-system,BlinkMacSystemFont,helvetica neue,Helvetica,SimHei,segoe ui,Roboto,Arial,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol}code,pre,tt,kbd,samp{font-family:source code pro,Menlo,Consolas,liberation mono,monospace;font-weight:500}</style></head><body><div class=wrapper><section id=header class=header><div class=header-left><a href=/><p class=site-name>Blog</p></a></div><div class=header-right><div class=nav><a class=nav-item href=/>Index</a><a class=nav-item href=/tags/>Tags</a><a class=nav-item href=/archives/>Archives</a><a class=nav-item href=/search/>Search</a><a class=nav-item href=/about/>About</a><script>const htmlEl=document.getElementsByTagName("html")[0],currentTheme=localStorage.getItem("theme")?localStorage.getItem("theme"):null;currentTheme&&(htmlEl.dataset.theme=currentTheme);const toggleTheme=e=>{htmlEl.dataset.theme=e,localStorage.setItem("theme",e)};localStorage.getItem("theme")==="dark"||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?htmlEl.dataset.theme="dark":toggleTheme("light")</script>
<button class="data-theme-btn dark-hidden" onclick='toggleTheme("dark")'><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3f4b67" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10A9 9 0 1110 3 7 7 0 0021 10z"/></svg></button>
<button class="data-theme-btn light-hidden" onclick='toggleTheme("light")'><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#e9e9e9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4 4l1 1m10 10 1 1M1 12h2m18 0h2M4 20l1-1M20 6l1-1"/></svg></button></div></div></section><section id=content><div class=article-containter><section class=article-header><h1>Creating Shell Builtins</h1><p class=article-date>2022-06-08</p></section><section class=article-labels><a class="article-tag li" href=/tags/c/><span class=hashtag>#</span>c</a><a class="article-tag li" href=/tags/bash/><span class=hashtag>#</span>bash</a><a class="article-tag li" href=/tags/shell/><span class=hashtag>#</span>shell</a><a class="article-tag li" href=/tags/programming/><span class=hashtag>#</span>programming</a></section><article class=markdown-body><h1 id=what-are-my-goals-for-this-article>What are my goals for this article?</h1><p>Before writing this, I was thinking about it from the reader&rsquo;s point of view, and it came to my attention that the goal of this article might get misinterpreted. So this section is to make sure that doesn&rsquo;t happen. My goal for this article, is very simple and straight forward. Following this, you&rsquo;ll have a much better understanding of what shell <code>builtins</code> are, and why you should use them instead of general commands, whenever you can. There is a section that shortly goes through the process of even creating one ourselves. But that should <strong>not be considered to be a tutorial</strong>. This article won&rsquo;t teach you how to create a built-ins yourself.</p><h1 id=word-of-caution>Word of caution</h1><p>Before moving forward, if you are an experienced Linux user or should I say a more technically advanced user, you might see some sections and think to yourself &ldquo;Well that ain&rsquo;t totally correct&rdquo;, and you will be correct to assume that. I&rsquo;ll not be going at depths for everything. My goal is to make sure the readers understand the topic in question. That includes new users. That&rsquo;s why I&rsquo;ll be hiding smaller details whenever necessary.</p><h1 id=what-are-built-ins>What are built-ins?</h1><p>Before we get into this exact question, I should explain first how exactly a command flow works. Say you&rsquo;ve opened a terminal, and enter a command like the following</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep <span style=color:#e6db74>&#39;something important&#39;</span> a-file | wc -l
</span></span></code></pre></div><p>What is happening behind the scenes? To understand builtins and why you should prefer them, this section is absolutely necessary. But to get to that, first, you&rsquo;ll be needing to understand a couple more things. I know this is getting deep already right? Bear with me. The following section takes care of the prerequisites.</p><h2 id=prerequisites>Prerequisites</h2><ol><li><p><strong>What are processes?</strong></p><p>Processes are basically running programs. When you start, say a file manager, you spawn a process, named that file manager. Your whole operating system runs consisting of many processes. Processes run alternatively. You might think &ldquo;Alternatively? What do you mean?&rdquo;. Well see the processor can&rsquo;t exactly run one single program to completion, can they? If that were to be true, then you couldn&rsquo;t even start an operating system, because there are some programs that are always running. We need them to stay that way. And if some process is already running, how can some other program run? Luckily that&rsquo;s not how they work. The CPU is the master here. CPU determines when and how long one process will be running. And it rotates this, quite fast, which is why we don&rsquo;t exactly notice anything, we think everything is running at once or simultaneously.</p><blockquote><p>Technically yes, a lot of the processes do run simultaneously of different threads. But that&rsquo;s not our topic today.</p></blockquote><p>Basically a process is a program, that&rsquo;s doing something. A program can spawn multiple processes to make its job completion faster. Here&rsquo;s a fun part to keep in mind, these individual processes have their own memory space. You can understand this analogy by thinking of an unmarried couple. The relationship is a program, each individual is a process. They both have their own house, job, car, etc. Processes of the same program are just like that.</p></li><li><p><strong>What is exec?</strong></p><p>Exec is a system call. Exec takes one argument and simply gives all the resources to that new process. It replaces the current process with the one you passed it.</p><blockquote><p>A system call is basically a keyword that lets us use some of the kernel&rsquo;s features directly without any abstractions if permissible. You can also think of system calls being features that the kernel lets higher level programs (Like a file manager or text editor) use for a successful operation.</p></blockquote><p>You can test <code>exec</code> with a shell command named (No surprises) <code>exec</code>. Try running <code>exec &lt;your-file-manager></code> in a terminal. You&rsquo;ll see the terminal closed, and the file manager opened. This is because exec replaced the current process, the terminal/shell prompt with a new one, the file manager.</p></li></ol><h2 id=what-happens-when-you-execute-a-command>What happens when you execute a command?</h2><p>Now that you have the understanding of what processes are and what <code>exec</code> is, the next question is, what happens when we write say <code>cat filename</code>? When you start a terminal, you have a total of two processes. One for the application itself, another for the shell, which in my case is <code>bash</code>. You can check that via a system monitor like the <code>mate-system-monitor</code>. Take a look at the picture below</p><p><a href=/blog/shell_builtins/terminal_process.png>Show image</a></p><p>Now when you execute a command, your shell spawns a new process, then replaces that process with the program you wanted to execute with exec. See the following diagram</p><blockquote><p>missing sorry :p</p></blockquote><p><a href=/blog/shell_builtins/command_execution.png>Show image</a></p><p>Test this with <code>sleep</code>. Open a terminal, and run <code>sleep 1d</code>. Then open the system monitor, and navigate to the terminal. You&rsquo;ll see something like the following</p><p><a href=/blog/shell_builtins/sleep_process.png>Show image</a></p><h2 id=so-what-is-a-builtin-exactly>So what is a builtin exactly?</h2><p>For starters, a builtin is not a binary file. You won&rsquo;t find it in your filesystem. Builtins are the shell&rsquo;s internal functions. If being specific, a builtin is a 48-byte data structure (Differs between hardware). When you use a builtin, a separate process is not spawned. A builtin to bash is the same as renaming a file is in a file manager. It&rsquo;s its own feature, it doesn&rsquo;t have to rely on any other program. This is important because a builtin essentially eliminates the initial system calls that bash had to use if it were an actual binary program. In other words, using builtins results in less overhead, and it&rsquo;s effectively much faster. Now should we test this? Absolutely!</p><p>One fine command that we can use, is <code>echo</code>. There was a time when experienced people in public forums or at other places used to say &ldquo;Don&rsquo;t use echo, use printf instead&rdquo;. This is because <code>printf</code> is a bash builtin whereas <code>echo</code> is an external command. That is not the case anymore. Try running <code>type echo</code>. You&rsquo;ll see something like the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debdut@mate-ubuntu:~/bash-5.0$ type echo
</span></span><span style=display:flex><span>echo is a shell builtin
</span></span></code></pre></div><p>While it is a shell builtin, we also have our old binary file as well. It&rsquo;s located at <code>/usr/bin/echo</code>. Use the <code>which</code> command to find it. Now, run the following script</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo<span style=color:#f92672>=</span>/usr/bin/echo
</span></span><span style=display:flex><span>time <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i in <span style=color:#f92672>{</span>0..1000<span style=color:#f92672>}</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>		$echo $i
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This script basically sets the variable echo to the binary echo, then prints the first 1000 numbers. It also keeps a record of how much time the whole process will take. On my computer, here&rsquo;s my result.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>real	0m2.666s
</span></span><span style=display:flex><span>user	0m1.073s
</span></span><span style=display:flex><span>sys	0m1.662s
</span></span></code></pre></div><p>Now change the variable&rsquo;s value from <code>/usr/bin/echo</code> to just <code>echo</code>. Rerun the script. I believe you don&rsquo;t even need to see the results. But still, just for the record,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>real	0m0.009s
</span></span><span style=display:flex><span>user	0m0.004s
</span></span><span style=display:flex><span>sys	0m0.005s
</span></span></code></pre></div><p>It&rsquo;s much much faster. I do hope now you&rsquo;re clear on what shell builtins are and why you should prefer them over other binary commands.</p><h2 id=test-run-writing-my-own-builtin>Test run, writing my own builtin</h2><p>The following section is not for everyone. Most are going to be fine with the information provided above. You&rsquo;ll need to know C if you want to understand any of the source code. You can just copy and paste everything to see the end result as well. Do note that I won&rsquo;t be explaining the source code much if any at all. So this isn&rsquo;t a tutorial of any kind.</p><ol><li><p><strong>Install bash-builtins</strong></p><p>First, we&rsquo;ll need a package named <code>bash-builtins</code>. I&rsquo;m on Ubuntu 20.04. The package name may vary depending on your distribution. Consult your distribution&rsquo;s documentation/wiki.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install bash-builtins -y
</span></span></code></pre></div></li><li><p><strong>Fix some paths</strong></p><p>Next, we&rsquo;ll need to copy some files over. Execute the following command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /usr/include/bash/include/* /usr/include/bash/
</span></span></code></pre></div><p>If you want to remove this package later, you&rsquo;ll have to manually remove the <code>/usr/include/bash</code> directory. Although it&rsquo;s around 500K in size. There&rsquo;s no reason to remove it, is there?</p></li><li><p><strong>Copy and paste the source code</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bash/config.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bash/posixjmp.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bash/shell.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bash/builtins.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sleep_</span>(){
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> EXECUTION_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>doc[]<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;Sleep for 5 minutes&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> builtin sleep_struct<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sleep&#34;</span>,
</span></span><span style=display:flex><span>	sleep_,
</span></span><span style=display:flex><span>	BUILTIN_ENABLED,
</span></span><span style=display:flex><span>	doc,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;Usage: sleep&#34;</span>,
</span></span><span style=display:flex><span>	NULL
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Copy the code above, and save it in a file named <code>sleep.c</code>. This is basically a builtin command, identical to <code>sleep</code>, much simpler though. It does nothing but waits for 5 seconds.</p></li><li><p><strong>Compile the program</strong></p><p>Because we aren&rsquo;t going to rebuild bash, we&rsquo;re gonna build a shared library that bash will load to memory when needed. Run the following command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcc -shared -fpic -o sleep.so sleep.c
</span></span></code></pre></div></li><li><p><strong>Enable the builtin</strong></p><p>Now you can enable the builtin using the <code>enable</code> builtin. This command manages the builtins. Use the following command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>enable -f <span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/sleep.so sleep
</span></span></code></pre></div></li></ol><p>Now you can test the builtin in two ways,</p><ol><li><p><em>Using the type command</em> Simply run <code>type sleep</code>. You should see something like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>debdut@mate-ubuntu:~/builtins$ type sleep
</span></span><span style=display:flex><span>sleep is a shell builtin
</span></span></code></pre></div><p>The older sleep can be found at <code>/usr/bin/sleep</code> (Use <code>which</code>).</p></li><li><p><em>Compare the process count</em></p><p>Remember previously we used the <code>sleep</code> command to see how there&rsquo;s a separate process getting generated? Let&rsquo;s try that out now. Our builtin basically sleeps for 5 seconds. Open the system monitor and the terminal side by side. Then simply run <code>sleep</code>. Now notice the system monitor, there&rsquo;s no process generated. It was run internally.</p></li></ol></article></div><section class=article-navigation><p><a class=link href=/blog/2022/06/perpetual-rocket.chat-develop-deployment/><span class=li></span>Perpetual Rocket.Chat Develop Deployment</a></p></section></section><script charset=utf-8>window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("id");e.intersectionRatio>0?document.querySelector(`nav li a[href="#${t}"]`).parentElement.classList.add("active"):document.querySelector(`nav li a[href="#${t}"]`).parentElement.classList.remove("active")})});document.querySelectorAll("h2[id]").forEach(t=>{e.observe(t)})})</script><aside class=toc><details open><summary class=toc-title>Table of Contents</summary><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#what-happens-when-you-execute-a-command>What happens when you execute a command?</a></li><li><a href=#so-what-is-a-builtin-exactly>So what is a builtin exactly?</a></li><li><a href=#test-run-writing-my-own-builtin>Test run, writing my own builtin</a></li></ul></nav></details></aside><section id=footer class="footer max-body-width"><div class=footer-wrap><p class=copyright>Â© 2022 Debdut Chakraborty</p></div><div class=footer-wrap><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a><span> | </span><a href=/index.xml target=_blank rel=noopener>RSS</a></div><div class=footer-wrap><p class=powerby><span>Powered by </span><a href=https://gohugo.io target=_blank rel=noopener>Hugo</a><span> and the </span><a href=https://github.com/qdzhang/hugo-notepadium-mod target=_blank rel=noopener>Notepadium-mod</a></p></div><div class=footer-wrap><a onclick='window.scrollTo({top:0,behavior:"smooth"})'>^ TOP ^</a></div></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script></div></body></html>